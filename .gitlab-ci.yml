variables:
  DEBIAN_FRONTEND: noninteractive
  MESON_BUILD_DIR: _build
  DOCS_BUILD_DIR: _reference

stages:
  - build
  - deploy

.build:ubuntu:base:
  image: ubuntu:devel
  before_script:
    - apt-get update &&
    - apt-get install -q -y --no-install-recommends
        gobject-introspection
        libgdk-pixbuf2.0-dev
        libgirepository1.0-dev
        libglib2.0-dev
        libgtk-3-dev
        libpopt-dev
        xmlto
        meson
        ninja-build
        python3-pip
        python3-setuptools
        xsltproc
        docbook-xsl-ns
        gi-docgen
  script:
    - meson setup ${MESON_BUILD_DIR} -Ddocbook_docs=enabled

build:ubuntu:
  stage: build
  extends:
    - .build:ubuntu:base
  script:
    - !reference [".build:ubuntu:base", "script"]
    - meson install -C ${MESON_BUILD_DIR}
    - mv ${MESON_BUILD_DIR}/docs/reference/libnotify-0 ${DOCS_BUILD_DIR}
  artifacts:
    expose_as: "Build artifacts"
    paths:
      - ${MESON_BUILD_DIR}/docs/notification-spec.html
      - ${DOCS_BUILD_DIR}
      - ${MESON_BUILD_DIR}/meson-logs

pages:
  stage: deploy
  script:
    - mkdir public
    - mv ${DOCS_BUILD_DIR}/* public/
  artifacts:
    when: on_success
    paths:
      - public
  # https://github.com/linux-test-project/lcov/issues/58
  allow_failure: true
